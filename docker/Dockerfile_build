FROM nixos/nix:2.6.0

COPY docker/nix-build.sh /
COPY . /node/
WORKDIR /node
RUN nix-env -i patchelf && \
    nix-collect-garbage && \
    nix-build ./default.nix && \
    rm -rf /node/
RUN mv /nix-build.sh /node/
RUN chmod +x /node/nix-build.sh

WORKDIR /node/build
ENTRYPOINT ["/node/nix-build.sh"]
CMD []