name: 'cargo nix-shell'
description: 'Call cargo under nix-shell; additionally patch interpreter of a binary'

inputs:
  command:
    description: 'subcommand of cargo to execute'
    required: true
  nix-file:
    description: '.nix file for nix-shell, e.g. shell.nix'
    required: false
    default: 'shell.nix'
  output-file:
    description: 'path to output binary that needs to be patched'
    required: false

runs:
  using: "composite"
  steps:
    - name: Call cargo command under nix-shell
      shell: bash
      run: |
        nix-shell --pure --run '${{ inputs.command }}' ${{ inputs.nix-file }}

    - name: Call patchelf to fix dynamic interpreter of a binary
      if: ${{ inputs.output-file != '' }}
      shell: bash
      run: |
        nix-shell --run 'LINKER=$(patchelf --print-interpreter /bin/bash); patchelf --set-interpreter $LINKER ${{ inputs.output-file }}'
