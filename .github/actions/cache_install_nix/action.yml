name: 'Cache install nix'
description: 'Restore nix-store from github cache and install nix'

inputs:
  cache-key:
    description: 'key used for storing in CI cache'
    required: true

runs:
  using: "composite"
  steps:
    - name: Prepare nix store
      shell: bash
      run: |
        # Create with liberal rights, otherwise cache action will complain
        # about permission errors.
        sudo mkdir -p /nix/store
        sudo chmod -R 777 /nix

    - name: Cache nix store
      uses: actions/cache@v2
      with:
        path: |
          /nix/store/**
          /nix/var/nix/db/db.sqlite
        key: ${{ inputs.cache-key }}

    - uses: cachix/install-nix-action@v17
      with:
        install_url: https://releases.nixos.org/nix/nix-2.7.0/install
        nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/2c162d49cd5b979eb66ff1653aecaeaa01690fcc.tar.gz
        extra_nix_config: |
          # save space on disk and in cache
          auto-optimise-store = true
          # keep all store paths necessary to build the outputs
          keep-outputs = true
          keep-derivations = true
