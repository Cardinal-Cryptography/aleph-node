---
name: Install rust toolchain
description: |
  Reads rust toolchain from rust-toolchain file and installs it. Optionally add given target.
inputs:
  target:
    description: Optional cargo target to install
    required: false
  components:
    description: Optional list of cargo components to install
    required: false

runs:
  using: composite
  steps:
    # This step needs to be extracted either to docker image or to setup of self-hosted runner
    - name: Install rustup
      shell: bash
      run: |
        if ! command -v rustup &>/dev/null; then
          curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused -fsSL \
            "https://sh.rustup.rs" | sh -s -- --default-toolchain none -y
          echo "${CARGO_HOME:-$HOME/.cargo}/bin" >> $GITHUB_PATH
        fi

    - name: Read channel from rust-toolchain.toml
      id: toolchain-channel
      uses: SebRollen/toml-action@v1.0.2
      with:
        file: 'rust-toolchain.toml'
        field: 'toolchain.channel'

    - name: Read components from rust-toolchain.toml
      id: toolchain-components
      uses: SebRollen/toml-action@v1.0.2
      with:
        file: 'rust-toolchain.toml'
        field: 'toolchain.components'

    - name: Read targets from rust-toolchain.toml
      id: toolchain-targets
      uses: SebRollen/toml-action@v1.0.2
      with:
        file: 'rust-toolchain.toml'
        field: 'toolchain.targets'

    - name: Read rust toolchain file
      id: read-rust-toolchain-file
      shell: bash
      run: |
        toolchain=$(cat rust-toolchain | xargs)
        echo "toolchain=${toolchain}" >> $GITHUB_OUTPUT

    - name: Install rust toolchain
      shell: bash
      run: |
        rustup toolchain install ${{ steps.toolchain-channel.outputs.channel }}

    - name: Add components (optional)
      if: inputs.components != ''
      shell: bash
      run: |
        rustup component add ${{ inputs.components }}

    - name: Add target (optional)
      if: inputs.target != ''
      shell: bash
      run: |
        rustup target add wasm32-unknown-unknown \
          --toolchain ${{ steps.read-rust-toolchain-file.outputs.toolchain }}
