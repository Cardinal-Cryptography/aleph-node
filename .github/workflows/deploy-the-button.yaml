name: Deploy the button game

on:
  pull_request:
    types: [labeled]
  push:
    branches:
    - benjamin
    - A0-1416-deployment-workflow-for-the-button-game

env:
  CHECKOUT_REF: A0-1416-deployment-workflow-for-the-button-game
  CACHE_KEY: fe-benjamin-button
  CONTRACTS_ENVFILE: fe-benjamin
  CARGOCONTRACT_REV: 5e6f941805e3d6032dbfa17771a887a362cb3460
  NODE_VERSION: 16
  S3BUCKET_NAME: alephzero-devnet-eu-central-1-ci
  S3BUCKET_PATH: contracts/fe-benjamin-button
  LABEL_DEPLOY_CONTRACTS: '[AZERO] DEPLOY-CONTRACTS'
  LABEL_DESTROYED: 'DESTROYED'
  LABEL_DEPLOYED: 'DEPLOYED'
  LABEL_DEPLOYED_CONTRACTS: 'DEPLOYED-CONTRACTS'

jobs:
  checkout_benjamin:
    if: (github.event_name == 'push') || (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == '[AZERO] DEPLOY-CONTRACTS')
    runs-on: ubuntu-20.04
    steps:
      - name: Fail when feature environment is not deployed
        if: !contains(github.event.pull_request.labels.*.name, env.LABEL_DEPLOYED)
        run: |
          echo "Feature environment does not seem to be deployed (label not found)"
          exit 1

      - name: Checkout repo
        uses: actions/checkout@v2.3.4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Get branch name and commit SHA
        id: get_branch
        uses: ./.github/actions/get-branch

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1

      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Install nightly
        run: rustup component add rust-src --toolchain nightly-2022-08-12-x86_64-unknown-linux-gnu

      - name: Install jq
        shell: bash
        run: |
          sudo apt-get install -y jq

      - name: Install binaryen
        shell: bash
        run: |
          wget https://github.com/WebAssembly/binaryen/releases/download/version_110/binaryen-version_110-x86_64-linux.tar.gz -O /tmp/binaryen-version_110-x86_64-linux.tar.gz
          tar -zxvf /tmp/binaryen-version_110-x86_64-linux.tar.gz -C /tmp
          sudo chmod +x /tmp/binaryen-version_110/bin/*
          sudo cp -rf /tmp/binaryen-version_110/* /usr/

      - name: Install node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore cache
        uses: ./.github/actions/restore-cache
        with:
          target-key: ${{ env.CACHE_KEY }}
          cargo-key: ${{ env.CACHE_KEY }}
          cache-version: v1

      - name: Install cargo additional libs
        run: cargo install dylint-link cargo-dylint

      - name: Install cargo-contract with bug fixes around URL parsing
        run: cargo install --git https://github.com/paritytech/cargo-contract.git --rev ${{ env.CARGOCONTRACT_REV }} --force

      - name: Copy metadata.json and addresses.json files from S3 bucket if contracts already deployed
        if: contains(github.event.pull_request.labels.*.name, env.LABEL_DEPLOYED_CONTRACTS)
        shell: bash
        run: |
          aws s3 cp s3://${{ env.S3BUCKET_NAME }}/${{ env.S3BUCKET_PATH }}/addresses.json contracts/addresses.json
          for i in ticket_token marketplace button game_token access_control; do \
            aws s3 cp s3://${{ env.S3BUCKET_NAME }}/${{ env.S3BUCKET_PATH }}/"$i"/metadata.json contracts/"$i"/target/ink/metadata.json; \
          done

      #- name: Restore contracts cache
      #  uses: actions/cache@v3
      #  env:
      #    SEGMENT_DOWNLOAD_TIMEOUT_MIN: "10"
      #  with:
      #    path: |
      #      contracts/addresses.json
      #      contracts/ticket_token/target/ink/metadata.json
      #      contracts/marketplace/target/ink/metadata.json
      #      contracts/button/target/ink/metadata.json
      #      contracts/game_token/target/ink/metadata.json
      #      contracts/access_control/target/ink/metadata.json
      #    key: contracts-addresses-${{ env.CACHE_KEY }}

      - name: Run clean.sh script
        continue-on-error: true
        shell: bash
        run: |
          source contracts/env/${{ env.CONTRACTS_ENVFILE }} && ./contracts/scripts/clean.sh

      - name: Run deploy.sh script
        shell: bash
        run: |
          source contracts/env/${{ env.CONTRACTS_ENVFILE }} && ./contracts/scripts/deploy.sh

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        env:
          AWS_REGION: us-east-1
        with:
          aws-access-key-id: ${{ secrets.AWS_DEVNET_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_DEVNET_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Copy metadata.json and addresses.json files onto S3 bucket
        shell: bash
        run: |
          aws s3 cp contracts/addresses.json s3://${{ env.S3BUCKET_NAME }}/${{ env.S3BUCKET_PATH }}/addresses.json
          for i in ticket_token marketplace button game_token access_control; do \
            aws s3 cp contracts/"$i"/target/ink/metadata.json s3://${{ env.S3BUCKET_NAME }}/${{ env.S3BUCKET_PATH }}/"$i"/metadata.json; \
          done
          echo -n "${{ steps.get_branch.outputs.sha_short }}" > commit_sha.txt
          aws s3 cp commit_sha.txt s3://${{ env.S3BUCKET_NAME }}/${{ env.S3BUCKET_PATH }}/commit_sha.txt

      - name: Trigger The Button deployment workflow
        run: |
          curl -X POST 'https://api.github.com/repos/Cardinal-Cryptography/the-button/actions/workflows/main.yaml/dispatches' \
          -H "Accept: application/vnd.github+json" \
          -H 'Authorization: Bearer ${{ secrets.CI_GH_TOKEN }}' \
          -d '{ "ref":"main", "inputs": { "buildImage": "false", "deployImage": "true", "buildFEBenjaminImage": "true", "deployFEBenjaminImage": "true" }}'

      - name: Add label to mark that contracts have been deployed
        uses: actions-ecosystem/action-add-labels@v1.1.0
        with:
          labels: ${{ env.LABEL_DEPLOYED_CONTRACTS }}
          github_token: ${{ secrets.CI_GH_TOKEN }}