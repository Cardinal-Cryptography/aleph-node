name: Deploy the button game

on:
  push:
    branches:
    - A0-1416-deployment-workflow-for-the-button-game

jobs:
  checkout_benjamin:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2.3.4
        with:
          ref: A0-1416-deployment-workflow-for-the-button-game

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1

      - name: Install WASM target
        run: rustup target add wasm32-unknown-unknown
      
      - name: Install cargo additional libs
        run: |
          cargo install dylint-link
          cargo install cargo-dylint

      - name: Install jq
        shell: bash
        run: |
          sudo apt-get install -y jq

      - name: Install binaryen
        shell: bash
        run: |
          wget https://github.com/WebAssembly/binaryen/releases/download/version_110/binaryen-version_110-x86_64-linux.tar.gz -O /tmp/binaryen-version_110-x86_64-linux.tar.gz
          tar -zxvf /tmp/binaryen-version_110-x86_64-linux.tar.gz -C /tmp
          sudo chmod +x /tmp/binaryen-version_110/bin/*
          sudo cp -rf /tmp/binaryen-version_110/* /usr/

      - name: Run additional cargo install
        shell: bash
        run: |
          cargo install --git https://github.com/paritytech/cargo-contract.git --rev 5e6f941805e3d6032dbfa17771a887a362cb3460 --force
    
      - name: Install node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Add nightly-2022-08-12-x86_64-unknown-linux-gnu
        run: |
          rustup component add rust-src --toolchain nightly-2022-08-12-x86_64-unknown-linux-gnu

      - name: Run deploy.sh script
        shell: bash
        run: |
          source contracts/env/fe-benjamin && ./contracts/scripts/deploy.sh