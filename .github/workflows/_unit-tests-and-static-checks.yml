---
name: Builds unit test binary and run unit tests, runs static rust code analysis and code formatting

on:
  workflow_call:

jobs:
  main:
    name: Run check, test and lints
    runs-on: self-hosted
    env:
      CARGO_INCREMENTAL: 0
      RUSTC_WRAPPER: sccache
    steps:
      - name: Checkout Source code
        uses: actions/checkout@v3

      - name: Run Format Checks
        run: |
          docker run --rm -v $(pwd):/code -u $UID:$(id -g) \
            -e RUSTC_WRAPPER=sccache \
            -e SCCACHE_BUCKET=${{ secrets.CI_MAINNET_S3BUCKET_NAME }} \
            -e SCCACHE_REGION=eu-central-1 \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_MAINNET_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_MAINNET_SECRET_ACCESS_KEY }}" \
            mikogs/rust-dev:v0.1.0-nightly-2022-10-30 \
            cargo fmt --all

      - name: Run Linter
        run: |
          docker run --rm -v $(pwd):/code -u $UID:$(id -g) \
            -e RUSTC_WRAPPER=sccache \
            -e SCCACHE_BUCKET=${{ secrets.CI_MAINNET_S3BUCKET_NAME }} \
            -e SCCACHE_REGION=eu-central-1 \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_MAINNET_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_MAINNET_SECRET_ACCESS_KEY }}" \
            mikogs/rust-dev:v0.1.0-nightly-2022-10-30 \
            cargo clippy --all-targets -- --no-deps -D warnings

      - name: Run Unit Test Suite
        run: |
          docker run --rm -v $(pwd):/code -u $UID:$(id -g) \
            -e RUSTC_WRAPPER=sccache \
            -e SCCACHE_BUCKET=${{ secrets.CI_MAINNET_S3BUCKET_NAME }} \
            -e SCCACHE_REGION=eu-central-1 \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_MAINNET_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_MAINNET_SECRET_ACCESS_KEY }}" \
            mikogs/rust-dev:v0.1.0-nightly-2022-10-30 \
            cargo test --features 'liminal-try-runtime liminal-runtime-benchmarks'
