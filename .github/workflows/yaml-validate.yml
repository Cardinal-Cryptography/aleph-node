---
name: GH Action YAML validator

on:
  pull_request:
    paths:
      - '.github/**.yml'
      - '.github/**.yaml'

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  main:
    name: YAML Validate
    runs-on: ubuntu-20.04
    steps:
      - name: GIT | Checkout source code
        uses: actions/checkout@v3

      - name: VALIDATE | Execute github-actions-validator
        env:
          DOCKER_IMAGE: public.ecr.aws/p6e8q1z1/github-actions-validator:0.3.2
        run: |
          set +e
          docker pull ${DOCKER_IMAGE}
          docker run --rm --name tmp-ghv -v $(pwd)/.github:/dot-github \
            ${DOCKER_IMAGE} \
            validate -p /dot-github > validation_result
          echo "------------------------------------------------"
          cat validation_result
          echo "------------------------------------------------"
          cat validation_result | grep '^E' > validation_result_errors
          if [[ $(cat validation_result_errors | wc -l) > 0 ]]; then
            echo "!!!"
            echo "!!! Errors have been found in GitHub YAML files!"
            echo "!!!"
            echo "------------------------------------------------"
            cat validation_result_errors
            echo "------------------------------------------------"
            echo "!!! Please fix them!"
            echo "!!!"
            exit 1
          fi
