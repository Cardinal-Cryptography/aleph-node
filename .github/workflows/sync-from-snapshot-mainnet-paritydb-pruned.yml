---
# This workflow performs sync to Mainnet from a pruned ParityDB snapshot using the latest
# main version.
#
# For now, this test not quite correctly tests sync Mainnet from latest aleph-node binary,
# for which we don't guarantee it will always happen to work.

name: Sync from snapshot, Mainnet, ParityDB pruned
on:
  # At 20:00 on Wednesday and Saturday
  schedule:
    - cron: '0 20 * * 3,6'
  workflow_dispatch:
  # remove before merge
  push:
    branches:
      - A0-4265-non-parity-db-tests

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  check-vars-and-secrets:
    name: Check vars and secrets
    uses: ./.github/workflows/_check-vars-and-secrets.yml
    secrets: inherit

  test-sync:
    name: Test sync
    needs: [check-vars-and-secrets]
    uses: ./.github/actions/sync-from-snapshot
    with:
      timeout: 60
      args: --mainnet --parity-db --pruned
      aws-access-key-id: ${{ secrets.AWS_MAINNET_S3_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_mAINNET_S3_SECRET_ACCESS_KEY }}
      slack-webhook: ${{ secrets.SLACK_WEBHOOK_DEV_ONDUTY }}
      # remove before merge
      snapshot-day: 2024-05-26
